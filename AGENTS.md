# Drupal Recipe Development Guide

This file can be used with any agent by symlinking to the appropriate filename (e.g., `GEMINI.md`, `.cursorrules`).

This file provides guidance to AI assistants and developers when working with code in this repository.

## Project Type
This is a Drupal 11 recipe project that provides configuration and modules for Drupal sites powering a decoupled frontend. It extends the `apax/recipe_apax_base` recipe with additional modules for GraphQL API, OAuth authentication, and content preview functionality.

## Architecture Overview

### Core Components
- **Recipe Definition** (`recipe.yml`): Defines modules to install and configuration actions
- **Configuration** (`config/`): Drupal configuration YAML files applied when recipe is installed
- **OAuth Authentication**: Uses Simple OAuth with client_credentials grant for API access
- **GraphQL API**: GraphQL Compose provides structured API for frontend consumption
- **Content Preview**: Decoupled preview iframe for editorial experience

### Key Modules Installed
- `graphql_compose` and related modules for GraphQL API
- `simple_oauth` for OAuth2 authentication
- `decoupled_preview_iframe` for content preview
- `visual_editor` for inline editing
- `view_unpublished` for draft content access

## Development Environment

### Lando Setup
The project uses Lando for containerized development:
- **Drupal**: Runs in `appserver` container at `/app`
- **Database**: MySQL 8.0 in `database` container
- **Test Suite**: Node.js environment in `node` container
- **Recipe Mount**: Project bound to `/var/www/recipe` in `appserver` container

### Essential Commands
- `lando start` - Start development environment (usually already running)
- `lando rebuild -y` - Reinstall site and reapply recipe (use for testing recipe changes)
- `lando test` - Run the automated test suite
- `lando export` - Export Drupal configuration to `.config-export/`
- `lando reset-oauth` - Generate OAuth clients for testing
- `lando drush watchdog:show` - View recent Drupal logs

### Test Suite Architecture
Located in `test/` directory:
- **Test Framework**: Jest with Node.js environment
- **Test Suite**: `test/tests/` directory with individual test files
- **Test Client**: `utils/drupal-client.js` handles OAuth authentication and API requests
- **Test Categories**: 
  - Connectivity tests (basic HTTP)
  - OAuth authentication tests
  - GraphQL API tests
  - Recipe module installation tests
  - Integration tests simulating frontend usage

## OAuth Configuration
The recipe creates two OAuth clients with client_credentials grant:
- **Previewer**: For previewing unpublished content
- **Viewer**: For general content access

OAuth keys are stored in `/keys/` directory (public.key, private.key) and automatically generated during setup.

## Configuration Management
- Complete Drupal config exports stored in `config/` directory are imported automatically when the recipe is applied
- Configs applied by modules during their installation must be whitelisted in `recipe.yml` under `config.import`
- Key configuration actions such as setting individual configuration values are defined in `recipe.yml` under `config.actions`
- The `clean-config-export.php` script is used by the `lando export` command to remove UUIDs from exported config

## Testing OAuth and GraphQL
The test suite expects:
- OAuth clients configured with client_credentials grant
- GraphQL permissions granted to anonymous and authenticated users
- Test environment variables in `test/.env` (auto-generated by setup-oauth)
- GraphQL must not be accessible to anonymous users.

## Common Development Patterns
- Use `lando rebuild -y` when testing recipe changes
- Run `lando export` after making configuration changes in Drupal UI
- OAuth authentication uses client_credentials grant (no username/password required)
- GraphQL endpoint is at `/graphql` with authentication via Bearer token

## Key File Locations
- `recipe.yml` - Recipe definition and configuration actions
- `config/` - Drupal configuration files
- `keys/` - OAuth RSA key pair (auto-generated)
- `test/` - Test suite and environment
- `scripts/` - PHP scripts for setup automation
- `.lando.yml` - Development environment configuration

## Best Practices
- Run tests to verify your changes
- Document architecture and project goals in AGENTS.md
- Make dependency updates via CLI tools like `lando composer` and `lando npm`
- Make heavy use of bash, node, eval, npx, and other available tools to formulate and execute bespoke solutions for maximum data gathering and troubleshooting efficiency
